<div class="fin-container">

  <div class="approval-buttons" *ngIf="viewMode && UiUtil.statusIsPending(rule.status) && canApprove()" finAuth="biz-admin">
    <button type="button" cuiButton color="primary" (click)="approve()">Approve</button>
    <button type="button" cuiButton color="primary" (click)="reject()">Reject</button>
    <button type="button" cuiButton color="secondary" (click)="cancel()">Cancel</button>
  </div>

  <form #form="ngForm">

    <div class="row" style="margin-top:5px; margin-bottom:23px;">
      <div class="col-lg-6" [class.disabled]="viewMode">
        <fin-input name="name" type="text" [(ngModel)]="rule.name" label="Rule Name" [disabled]="true"
                   [matTooltip]="rule.name" [matTooltipDisabled]="!rule.name || rule.name.length<50" matTooltipPosition="above"></fin-input>
      </div>
      <div class="col-lg-6">
        <div fxLayout="row" fxLayoutAlign="center start" class="status-section">
          <div *ngIf="isApprovedOnce()" class="form-group-check">
            <span class="in-use text--danger cursor-pointer" [fxShow]="isInUse()"
                  [matTooltip]="usingSubmeasuresNamesTooltip">in use</span>
            <fin-checkbox name="status" label="Active" [(model)]="rule.activeStatus"
                          trueVal="A" falseVal="I" [inline]="true" [disabled]="viewMode || isInUse()"></fin-checkbox>
          </div>
          <div class="form-group-text" style="margin-left:30px;">Status: {{UiUtil.getStatusText(rule.status)}}</div>
        </div>
      </div>
    </div>

    <div [class.disabled]="isApprovedOnce() || viewMode">

      <div class="row">
        <div class="col-lg-6">
          <cui-select name="driver" [(ngModel)]="rule.driverName" [items]="drivers" label="Driver*"
                      optionsKey="name" optionsValue="value" [required]="true" (ngModelChange)="valueChange()"></cui-select>
        </div>
        <div class="col-lg-6">
          <cui-select name="period" [(ngModel)]="rule.period" [items]="periods" label="Driver Period*" dropdownMaxHeight="220px"
                      [required]="true" optionsKey="period" optionsValue="period" (ngModelChange)="valueChange()"></cui-select>
        </div>
      </div>
      <br>

      <div class="row">
        <div class="col-lg-6">
          <div class="form-group-max-width">
            <div class="border-and-padding">
              <div style="margin-bottom:-10px;">
                <div class="left text-center half-margin-bottom form-group-max-width">Matching Criteria</div>
                <cui-select name="salesMatch" [(ngModel)]="rule.salesMatch" [items]="salesMatches" label="Sales" empty="true"
                            optionsKey="name" optionsValue="value" (ngModelChange)="valueChange()"></cui-select>
                <cui-select *ngIf="moduleId!=4" name="productMatch" [disabled]="!!rule.beMatch" [(ngModel)]="rule.productMatch" [items]="productMatches" label="Product"
                            empty="true" optionsKey="name" optionsValue="value" (ngModelChange)="valueChange()"></cui-select>
                <cui-select name="scmsMatch" [(ngModel)]="rule.scmsMatch" [items]="scmsMatches" label="SCMS"
                            empty="true" optionsKey="match" optionsValue="match" (ngModelChange)="valueChange()"></cui-select>
                <cui-select *ngIf="moduleId!=4" name="beMatch" [disabled]="!!rule.productMatch" [(ngModel)]="rule.beMatch" [items]="beMatches" label="Internal Business Entity"
                            empty="true" optionsKey="name" optionsValue="value" (ngModelChange)="valueChange()"></cui-select>
                <cui-select *ngIf="moduleId!=4" name="leMatch"  [(ngModel)]="rule.legalEntityMatch" [items]="legalEntityMatches" label="Legal Entity"
                            empty="true" optionsKey="match" optionsValue="match" (ngModelChange)="valueChange()"></cui-select>
                <cui-select name="cntyMatch" [(ngModel)]="rule.countryMatch" [items]="countryMatches" dropdownMaxHeight="300"
                            optionsKey="name" optionsValue="value" empty="true" label="Country" (ngModelChange)="valueChange()"></cui-select>
                <cui-select name="extTheaterMatch" [(ngModel)]="rule.extTheaterMatch" [items]="extTheaterMatches"
                            optionsKey="name" optionsValue="value" empty="true" label="External Theater" (ngModelChange)="valueChange()"></cui-select>
                <cui-multiselect *ngIf="moduleId!=4" name="glSegmentsMatch"  [(ngModel)]="rule.glSegmentsMatch" [items]="glSegmentMatches"
                                 optionsKey="name" optionsValue="value" empty="true" label="GL Segments" (ngModelChange)="valueChange()"></cui-multiselect>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6 conditional-div">
          <div class="form-group-max-width">
            <div class="border-and-padding">
              <div style="margin-bottom:-10px;">
                <div class="right text-center half-margin-bottom form-group-max-width">Selection Criteria</div>
                <div class="row">
                  <div class="col-2">
                    <div class="form-group-text">SL1</div>
                    <div class="form-group-text">SL2</div>
                    <div class="form-group-text">SL3</div>
                    <div *ngIf="moduleId!=4" class="form-group-text">TG</div>
                    <div *ngIf="moduleId!=4" class="form-group-text">BU</div>
                    <div *ngIf="moduleId!=4" class="form-group-text">PF</div>
                    <div class="form-group-text">SCMS</div>
                    <div *ngIf="moduleId!=4" class="form-group-text">BE</div>
                    <!-- <div *ngIf="moduleId!=1 && moduleId!=2" class="form-group-text">Country</div>
                    <div *ngIf="moduleId!=1 && moduleId!=2" class="form-group-text">Ext Theater</div> -->
                  </div>
                  <div class="col-3">
                    <cui-select name="salesSL1Cond" class="replace-label-space" [(ngModel)]="rule.salesSL1CritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.salesSL1CritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange();sl2Select.blurInput()"></cui-select>
                    <cui-select name="salesSL2Cond" class="replace-label-space" [(ngModel)]="rule.salesSL2CritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.salesSL2CritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange();sl3Select.blurInput()"></cui-select>
                    <cui-select name="salesSL3Cond" class="replace-label-space" [(ngModel)]="rule.salesSL3CritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.salesSL3CritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange()"></cui-select>
                    <cui-select *ngIf="moduleId!=4" name="prodTGCond" class="replace-label-space" [(ngModel)]="rule.prodTGCritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.prodTGCritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange();buSelect.blurInput()"></cui-select>
                    <cui-select *ngIf="moduleId!=4" name="prodBUCond" class="replace-label-space" [(ngModel)]="rule.prodBUCritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.prodBUCritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange();pfSelect.blurInput()"></cui-select>
                    <cui-select *ngIf="moduleId!=4" name="prodPFCond" class="replace-label-space" [(ngModel)]="rule.prodPFCritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.prodPFCritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange()"></cui-select>
                    <cui-select name="scmsCond" class="replace-label-space" [(ngModel)]="rule.scmsCritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.scmsCritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange()"></cui-select>
                    <cui-select *ngIf="moduleId!=4" name="beCond" class="replace-label-space" [(ngModel)]="rule.beCritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!rule.beCritChoices.length" optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange()"></cui-select>
                    <!-- <cui-select *ngIf="moduleId!=1 && moduleId!=2" name="countryCond" class="replace-label-space" [(ngModel)]="rule.countryCritCond" [items]="conditionalOperators"
                                empty="true" [required]="!!(rule.countryCritChoices && rule.countryCritChoices.length)"  optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange()"></cui-select>
                    <cui-select *ngIf="moduleId!=1 && moduleId!=2" name="externalTheaterCond" class="replace-label-space" [(ngModel)]="rule.externalTheaterCritCond" [items]="conditionalOperators"
                                empty="true"  [required]="!!(rule.externalTheaterCritChoices && rule.externalTheaterCritChoices.length)"  optionsKey="operator" optionsValue="operator" (ngModelChange)="valueChange()"></cui-select>   -->
                    </div>
                  <div class="col-7">
                    <cui-multiselect name="sl1SalesChoice" [(ngModel)]="rule.salesSL1CritChoices" [items]="salesSL1Choices" class="replace-label-space" optionsKey="name" optionsValue="name"
                                     empty="true" (ngModelChange)="valueChange();sl2Select.blurInput()" [required]="!!rule.salesSL1CritCond"></cui-multiselect>
                    <fin-input #sl2Select name="sl2SalesChoice" [(ngModel)]="rule.salesSL2CritChoices" [ngModelOptions]="{updateOn: 'blur'}"
                               class="replace-label-space" placeholder="comma separated values"
                               [stringToArray]="true" [options]="salesSL2ChoiceOptions" (ngModelChange)="valueChange();sl3Select.blurInput()" [required]="!!rule.salesSL2CritCond"></fin-input>
                    <fin-input #sl3Select name="sl3SalesChoice" [(ngModel)]="rule.salesSL3CritChoices" [ngModelOptions]="{updateOn: 'blur'}"
                               class="replace-label-space" placeholder="comma separated values"
                               [stringToArray]="true" [options]="salesSL3ChoiceOptions" (ngModelChange)="valueChange()" [required]="!!rule.salesSL3CritCond"></fin-input>
                    <cui-multiselect *ngIf="moduleId!=4" name="prodTGChoice" [(ngModel)]="rule.prodTGCritChoices" [items]="prodTgChoices" optionsKey="name"
                                     class="replace-label-space" optionsValue="name" dropdownMaxHeight="300"
                                     empty="true" (ngModelChange)="valueChange();buSelect.blurInput()" [required]="!!rule.prodTGCritCond"></cui-multiselect>
                    <fin-input *ngIf="moduleId!=4" #buSelect name="prodBUChoice" [(ngModel)]="rule.prodBUCritChoices" [ngModelOptions]="{updateOn: 'blur'}"
                               class="replace-label-space" placeholder="comma separated values"
                               [stringToArray]="true" [options]="prodBUChoiceOptions" (ngModelChange)="valueChange();pfSelect.blurInput()" [required]="!!rule.prodBUCritCond"></fin-input>
                    <fin-input *ngIf="moduleId!=4" #pfSelect name="prodPFChoice" [(ngModel)]="rule.prodPFCritChoices" [ngModelOptions]="{updateOn: 'blur'}"
                               class="replace-label-space" placeholder="comma separated values"
                               [stringToArray]="true" [options]="prodPFChoiceOptions" (ngModelChange)="valueChange()" [required]="!!rule.prodPFCritCond"></fin-input>
                    <cui-multiselect name="scmsChoice" [(ngModel)]="rule.scmsCritChoices" [items]="scmsChoices" optionsKey="name"
                                     class="replace-label-space" optionsValue="name" empty="true" (ngModelChange)="valueChange()" [required]="!!rule.scmsCritCond"></cui-multiselect>
                    <cui-multiselect *ngIf="moduleId!=4" name="beChoice" [(ngModel)]="rule.beCritChoices" [items]="internalBeChoices" optionsKey="name"
                                     optionsValue="name" dropdownMaxHeight="300"
                                     class="replace-label-space" empty="true" (ngModelChange)="valueChange()" [required]="!!rule.beCritCond"></cui-multiselect>
                    <!-- <fin-input *ngIf="moduleId!=1 && moduleId!=2" #cs name="countryCritChoice" [(ngModel)]="rule.countryCritChoices" [ngModelOptions]="{updateOn: 'blur'}"
                                     class="replace-label-space" placeholder="comma separated values"
                                     [stringToArray]="true" [options]="countryChoiceOptions" (ngModelChange)="valueChange()" [required]="!!rule.countryCritCond"></fin-input>                  -->
                    <!-- <cui-multiselect *ngIf="moduleId!=1 && moduleId!=2" #externalTheaterSelect name="externalTheaterChoice" [(ngModel)]="rule.externalTheaterCritChoices" [items]="externalTheaterChoices" optionsKey="name" -->
                                     <!-- class="replace-label-space" optionsValue="name" empty="true" (ngModelChange)="valueChange();" [required]="!!rule.externalTheaterCritCond"></cui-multiselect> -->
                    
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div> <!-- disable if approvedOnce -->

    <div *ngIf="!viewMode" finAuth="super-user" class="fin-footer-buttons">
      <button type="submit" finErrorFlash cuiButton color="primary" (click)="submitForApproval()" [class.disabled]="disableSave()">Submit</button>
      <button type="button" finErrorFlash cuiButton color="primary" (click)="saveToDraft()" [class.disabled]="disableSave()">Save as Draft</button>
      <button type="button" cuiButton color="secondary" (click)="cancel()">Cancel</button>
      <button type="button" cuiButton color="secondary" (click)="reset()" [class.disabled]="disableSave()">Reset</button>
    </div>

    <div *ngIf="viewMode"><br><br></div>

    <!--
        <div>form.valid: {{form.valid}}</div>
        <div>form.invalid: {{form.invalid}}</div>
        <div>form.pending: {{form.pending}}</div>
    -->

  </form>
</div>
